<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - NETRA TAX</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>üîê NETRA TAX</h1>
                <p>Tax Fraud Detection</p>
            </div>
            <ul class="navbar-menu">
                <li><a href="/index.html" class="nav-link">üìä Dashboard</a></li>
                <li><a href="/upload.html" class="nav-link">üì§ Upload</a></li>
                <li><a href="/company-explorer.html" class="nav-link">üè¢ Companies</a></li>
                <li><a href="/invoice-explorer.html" class="nav-link">üìÑ Invoices</a></li>
                <li><a href="/graph-visualizer.html" class="nav-link">üï∏Ô∏è Network</a></li>
                <li><a href="/reports.html" class="nav-link active">üìë Reports</a></li>
                <li><a href="/admin.html" class="nav-link">‚öôÔ∏è Admin</a></li>
                <li>
                    <div class="dropdown">
                        <a href="#" class="nav-link">üë§ <span class="user-name">User</span></a>
                        <div class="dropdown-menu user-dropdown"></div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h2>üìë Fraud Detection Reports</h2>
                <p>Generate and manage comprehensive fraud analysis reports</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openGenerateReportModal()">üìã Generate New Report</button>
            </div>
        </div>

        <!-- Report Templates Section -->
        <div class="table-section" style="margin-bottom: 32px;">
            <h3 style="margin-bottom: 16px; font-size: 18px; color: var(--primary-color); font-weight: 600;">Report Templates</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                <div class="report-template" style="background: var(--light-bg); padding: 20px; border-radius: 12px; border: 2px solid #ecf0f1; cursor: pointer; transition: all 300ms ease;" onclick="selectTemplate('comprehensive')">
                    <div style="font-size: 32px; margin-bottom: 12px;">üìä</div>
                    <h4 style="color: var(--primary-color); margin-bottom: 8px; font-weight: 600;">Comprehensive Report</h4>
                    <p style="color: var(--gray-dark); font-size: 13px; margin-bottom: 12px;">Complete fraud analysis with GNN risk scores, network patterns, and recommendations</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary-color);">20-30 pages</span>
                        <span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary-color);">Detailed</span>
                    </div>
                </div>

                <div class="report-template" style="background: var(--light-bg); padding: 20px; border-radius: 12px; border: 2px solid #ecf0f1; cursor: pointer; transition: all 300ms ease;" onclick="selectTemplate('executive')">
                    <div style="font-size: 32px; margin-bottom: 12px;">üìà</div>
                    <h4 style="color: var(--primary-color); margin-bottom: 8px; font-weight: 600;">Executive Summary</h4>
                    <p style="color: var(--gray-dark); font-size: 13px; margin-bottom: 12px;">High-level overview with key findings, risk scores, and immediate actions required</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary-color);">3-5 pages</span>
                        <span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary-color);">Quick</span>
                    </div>
                </div>

                <div class="report-template" style="background: var(--light-bg); padding: 20px; border-radius: 12px; border: 2px solid #ecf0f1; cursor: pointer; transition: all 300ms ease;" onclick="selectTemplate('network')">
                    <div style="font-size: 32px; margin-bottom: 12px;">üï∏Ô∏è</div>
                    <h4 style="color: var(--primary-color); margin-bottom: 8px; font-weight: 600;">Network Analysis</h4>
                    <p style="color: var(--gray-dark); font-size: 13px; margin-bottom: 12px;">Deep-dive into fraud rings, circular trades, and entity relationships</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary-color);">10-15 pages</span>
                        <span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary-color);">Technical</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generated Reports Section -->
        <div class="table-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 18px; color: var(--primary-color); font-weight: 600;">Your Reports</h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="reportSearch" placeholder="Search reports..." style="padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 13px;" onkeyup="filterReports()" />
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Report Name</th>
                            <th>Type</th>
                            <th>Created Date</th>
                            <th>Company/Entity</th>
                            <th>Status</th>
                            <th>Pages</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTable">
                        <tr>
                            <td colspan="7" class="text-center" style="padding: 40px;">
                                <p style="color: var(--gray-medium); margin-bottom: 16px;">Loading reports...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Generate Report Modal -->
    <div id="generateReportModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 style="font-size: 20px; color: var(--primary-color); margin-bottom: 24px;">Generate New Report</h3>

            <form onsubmit="submitGenerateReport(event)">
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; display: block;">Report Type</label>
                    <select id="reportTypeSelect" style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 14px;" required>
                        <option value="">-- Select Report Type --</option>
                        <option value="comprehensive">Comprehensive Report (20-30 pages)</option>
                        <option value="executive">Executive Summary (3-5 pages)</option>
                        <option value="network">Network Analysis (10-15 pages)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; display: block;">Company/Entity (GSTIN)</label>
                    <input type="text" id="reportEntityInput" placeholder="Enter GSTIN" style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 14px;" required />
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; display: block;">Include</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="includeNetwork" checked />
                            <span style="font-size: 14px;">Network Analysis & Fraud Rings</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="includeInvoices" checked />
                            <span style="font-size: 14px;">Invoice-level Analysis</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="includeRecommendations" checked />
                            <span style="font-size: 14px;">Recommendations & Actions</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="includeVisualization" checked />
                            <span style="font-size: 14px;">Charts & Visualizations</span>
                        </label>
                    </div>
                </div>

                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn" style="background-color: #bdc3c7; color: white;" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">üìã Generate Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2024 NETRA TAX - AI-Powered Tax Fraud Detection. All rights reserved.</p>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let generatedReports = [];
        let selectedTemplate = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            requireAuth();
            await loadUserInfo();
            await loadReports();
        });

        /**
         * Load user info
         */
        async function loadUserInfo() {
            try {
                const user = getCurrentUser();
                if (!user) {
                    const response = await api.getCurrentUser();
                    setCurrentUser(response);
                    updateUserDropdown(response);
                } else {
                    updateUserDropdown(user);
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        /**
         * Update user dropdown
         */
        function updateUserDropdown(user) {
            const userNameElement = document.querySelector('.user-name');
            const userDropdown = document.querySelector('.user-dropdown');

            if (userNameElement) userNameElement.textContent = user.full_name || user.username;

            if (userDropdown) {
                userDropdown.innerHTML = `
                    <a href="/profile.html">üë§ My Profile</a>
                    <a href="/settings.html">‚öôÔ∏è Settings</a>
                    <hr style="margin: 8px 0; border: none; border-top: 1px solid #ecf0f1;">
                    <a onclick="logoutUser()" style="cursor: pointer;">üö™ Logout</a>
                `;
            }
        }

        /**
         * Select template
         */
        function selectTemplate(template) {
            selectedTemplate = template;
            document.getElementById('reportTypeSelect').value = template;
        }

        /**
         * Open generate report modal
         */
        function openGenerateReportModal() {
            document.getElementById('generateReportModal').classList.add('open');
        }

        /**
         * Close modal
         */
        function closeModal() {
            document.getElementById('generateReportModal').classList.remove('open');
        }

        /**
         * Submit generate report
         */
        async function submitGenerateReport(e) {
            e.preventDefault();

            const reportType = document.getElementById('reportTypeSelect').value;
            const entity = document.getElementById('reportEntityInput').value.trim();

            if (!reportType || !entity) {
                showNotification('Please fill in all fields', 'warning');
                return;
            }

            try {
                showNotification('Generating report... This may take a moment', 'info');

                const response = await api.generateReport(entity, reportType);

                if (response.report_id) {
                    showNotification('Report generated successfully!', 'success');
                    closeModal();
                    document.getElementById('generateReportModal').querySelector('form').reset();
                    await loadReports();
                }
            } catch (error) {
                console.error('Report generation error:', error);
                showNotification('Failed to generate report: ' + error.message, 'error');
            }
        }

        /**
         * Load reports
         */
        async function loadReports() {
            try {
                // Sample reports data
                generatedReports = [
                    {
                        id: 'RPT-001',
                        name: 'Company A - Comprehensive Analysis',
                        type: 'comprehensive',
                        date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        entity: '18AABCT1234H1Z0',
                        status: 'completed',
                        pages: 25,
                    },
                    {
                        id: 'RPT-002',
                        name: 'Company B - Network Analysis',
                        type: 'network',
                        date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        entity: '12BCDEF5678G2Z1',
                        status: 'completed',
                        pages: 12,
                    },
                    {
                        id: 'RPT-003',
                        name: 'Company E - Executive Summary',
                        type: 'executive',
                        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        entity: '14RSTU7890P5Z4',
                        status: 'completed',
                        pages: 4,
                    },
                ];

                displayReports();
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        /**
         * Display reports
         */
        function displayReports() {
            const tbody = document.getElementById('reportsTable');

            if (generatedReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 40px;">No reports generated yet. <a href="#" onclick="openGenerateReportModal()" style="color: var(--accent-color); text-decoration: none;">Create one now ‚Üí</a></td></tr>';
                return;
            }

            tbody.innerHTML = generatedReports
                .map(
                    report => `
                <tr>
                    <td><strong>${report.name}</strong></td>
                    <td>${capitalize(report.type)}</td>
                    <td>${formatDate(report.date)}</td>
                    <td>${report.entity}</td>
                    <td><span style="color: var(--success-color); font-weight: 600;">‚úì ${capitalize(report.status)}</span></td>
                    <td>${report.pages}</td>
                    <td>
                        <button class="btn btn-small" onclick="downloadReport('${report.id}')">‚¨á Download</button>
                        <button class="btn btn-small" onclick="viewReport('${report.id}')" style="background-color: var(--secondary-color); color: var(--dark);">üëÅ View</button>
                        <button class="btn btn-small" onclick="deleteReport('${report.id}')" style="background-color: #e74c3c; color: white;">üóë</button>
                    </td>
                </tr>
            `,
                )
                .join('');
        }

        /**
         * Download report
         */
        function downloadReport(reportId) {
            try {
                const report = generatedReports.find(r => r.id === reportId);
                if (!report) return;

                const element = document.createElement('a');
                element.href = `http://localhost:8000/api/reports/download/${reportId}`;
                element.download = `${report.id}_${report.name}.pdf`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);

                showNotification('Report downloaded', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download report', 'error');
            }
        }

        /**
         * View report
         */
        function viewReport(reportId) {
            window.open(`/report-viewer.html?id=${reportId}`, '_blank');
        }

        /**
         * Delete report
         */
        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to delete this report?')) {
                return;
            }

            try {
                generatedReports = generatedReports.filter(r => r.id !== reportId);
                displayReports();
                showNotification('Report deleted', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete report', 'error');
            }
        }

        /**
         * Filter reports
         */
        function filterReports() {
            const query = document.getElementById('reportSearch').value.toLowerCase();
            const filtered = generatedReports.filter(
                r => r.name.toLowerCase().includes(query) || r.entity.toLowerCase().includes(query),
            );

            const tbody = document.getElementById('reportsTable');
            tbody.innerHTML = filtered
                .map(
                    report => `
                <tr>
                    <td><strong>${report.name}</strong></td>
                    <td>${capitalize(report.type)}</td>
                    <td>${formatDate(report.date)}</td>
                    <td>${report.entity}</td>
                    <td><span style="color: var(--success-color); font-weight: 600;">‚úì ${capitalize(report.status)}</span></td>
                    <td>${report.pages}</td>
                    <td>
                        <button class="btn btn-small" onclick="downloadReport('${report.id}')">‚¨á Download</button>
                        <button class="btn btn-small" onclick="viewReport('${report.id}')" style="background-color: var(--secondary-color); color: var(--dark);">üëÅ View</button>
                        <button class="btn btn-small" onclick="deleteReport('${report.id}')" style="background-color: #e74c3c; color: white;">üóë</button>
                    </td>
                </tr>
            `,
                )
                .join('');
        }

        /**
         * Capitalize string
         */
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).replace(/_/g, ' ');
        }
    </script>
</body>
</html>
