<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Center - NETRA TAX</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>üîê NETRA TAX</h1>
                <p>Tax Fraud Detection</p>
            </div>
            <ul class="navbar-menu">
                <li><a href="/index.html" class="nav-link">üìä Dashboard</a></li>
                <li><a href="/upload.html" class="nav-link active">üì§ Upload</a></li>
                <li><a href="/company-explorer.html" class="nav-link">üè¢ Companies</a></li>
                <li><a href="/invoice-explorer.html" class="nav-link">üìÑ Invoices</a></li>
                <li><a href="/graph-visualizer.html" class="nav-link">üï∏Ô∏è Network</a></li>
                <li><a href="/reports.html" class="nav-link">üìë Reports</a></li>
                <li><a href="/admin.html" class="nav-link">‚öôÔ∏è Admin</a></li>
                <li>
                    <div class="dropdown">
                        <a href="#" class="nav-link">üë§ <span class="user-name">User</span></a>
                        <div class="dropdown-menu user-dropdown"></div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h2>üì§ Upload & Process Files</h2>
                <p>Import CSV files with company and invoice data for fraud detection analysis</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="table-section" style="margin-bottom: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 18px; color: var(--primary-color); font-weight: 600;">New File Upload</h3>
                <button class="btn btn-primary" onclick="downloadTemplate()">üì• Download Template</button>
            </div>

            <!-- File Upload Area -->
            <div
                id="dropZone"
                style="
                    border: 2px dashed #bdc3c7;
                    border-radius: 12px;
                    padding: 48px;
                    text-align: center;
                    background-color: #f9f9f9;
                    cursor: pointer;
                    transition: all 300ms ease-in-out;
                    margin-bottom: 24px;
                "
            >
                <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
                <h4 style="color: var(--primary-color); margin-bottom: 8px;">Drag and drop your CSV file here</h4>
                <p style="color: var(--gray-dark); margin-bottom: 16px;">or click to select from your computer</p>
                <p style="font-size: 12px; color: var(--gray-medium);">
                    Supported format: CSV (Max 100MB) - Companies & Invoices data
                </p>
                <input type="file" id="fileInput" accept=".csv" style="display: none" />
            </div>

            <!-- Upload Progress -->
            <div id="uploadProgress" style="display: none; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: var(--primary-color);">Uploading...</span>
                    <span id="uploadPercent" style="color: var(--gray-dark);">0%</span>
                </div>
                <div style="background-color: #ecf0f1; border-radius: 8px; height: 8px; overflow: hidden;">
                    <div
                        id="uploadBar"
                        style="
                            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
                            height: 100%;
                            width: 0%;
                            transition: width 300ms ease;
                        "
                    ></div>
                </div>
            </div>

            <!-- File Details -->
            <div id="fileDetails" style="display: none; background-color: var(--light-bg); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <p style="margin-bottom: 12px;">
                    <strong>File:</strong> <span id="fileName"></span>
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Size:</strong> <span id="fileSize"></span>
                </p>
                <p style="margin-bottom: 12px;">
                    <strong>Status:</strong>
                    <span id="fileStatus" style="color: var(--primary-color); font-weight: 600;"></span>
                </p>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <button id="uploadBtn" class="btn btn-primary" style="display: none;">‚úì Confirm Upload</button>
                <button id="cancelBtn" class="btn" style="background-color: #bdc3c7; color: white; display: none;" onclick="cancelUpload()">‚úï Cancel</button>
            </div>

            <!-- Validation Results -->
            <div id="validationResults" style="display: none; background-color: var(--light-bg); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success-color);">
                <h4 style="color: var(--primary-color); margin-bottom: 12px;">‚úì File Validation Results</h4>
                <div id="validationContent"></div>
            </div>

            <!-- Error Messages -->
            <div id="errorAlert" style="display: none; background-color: rgba(231, 76, 60, 0.1); padding: 16px; border-radius: 8px; border-left: 4px solid var(--danger-color); margin-bottom: 24px;">
                <p style="color: var(--danger-color); font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Upload Error</p>
                <p id="errorContent" style="color: var(--gray-dark);"></p>
            </div>
        </div>

        <!-- Recent Uploads Section -->
        <div class="table-section">
            <h3 style="margin-bottom: 16px; font-size: 18px; color: var(--primary-color); font-weight: 600;">Recent Uploads</h3>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Upload Date</th>
                            <th>Status</th>
                            <th>Companies</th>
                            <th>Invoices</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="uploadsTable">
                        <tr>
                            <td colspan="6" class="text-center" style="padding: 40px;">
                                <p style="color: var(--gray-medium); margin-bottom: 16px;">Loading uploads...</p>
                                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2024 NETRA TAX - AI-Powered Tax Fraud Detection. All rights reserved.</p>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let selectedFile = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            requireAuth();
            await loadUserInfo();
            setupDragDrop();
            await loadRecentUploads();
        });

        /**
         * Load user info
         */
        async function loadUserInfo() {
            try {
                const user = getCurrentUser();
                if (!user) {
                    const response = await api.getCurrentUser();
                    setCurrentUser(response);
                    updateUserDropdown(response);
                } else {
                    updateUserDropdown(user);
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        /**
         * Update user dropdown
         */
        function updateUserDropdown(user) {
            const userNameElement = document.querySelector('.user-name');
            const userDropdown = document.querySelector('.user-dropdown');

            if (userNameElement) userNameElement.textContent = user.full_name || user.username;

            if (userDropdown) {
                userDropdown.innerHTML = `
                    <a href="/profile.html">üë§ My Profile</a>
                    <a href="/settings.html">‚öôÔ∏è Settings</a>
                    <hr style="margin: 8px 0; border: none; border-top: 1px solid #ecf0f1;">
                    <a onclick="logoutUser()" style="cursor: pointer;">üö™ Logout</a>
                `;
            }
        }

        /**
         * Setup drag and drop
         */
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.style.backgroundColor = 'rgba(255, 200, 1, 0.1)';
                dropZone.style.borderColor = 'var(--secondary-color)';
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.style.backgroundColor = '#f9f9f9';
                dropZone.style.borderColor = '#bdc3c7';
            });

            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.style.backgroundColor = '#f9f9f9';
                dropZone.style.borderColor = '#bdc3c7';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    selectFile(files[0]);
                }
            });

            fileInput.addEventListener('change', e => {
                if (e.target.files.length > 0) {
                    selectFile(e.target.files[0]);
                }
            });
        }

        /**
         * Select file
         */
        function selectFile(file) {
            // Validate file type
            if (!file.name.endsWith('.csv')) {
                showError('Please select a CSV file');
                return;
            }

            // Validate file size (max 100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('File size exceeds 100MB limit');
                return;
            }

            selectedFile = file;

            // Show file details
            document.getElementById('fileDetails').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileStatus').textContent = 'Ready for upload';

            // Show upload button
            document.getElementById('uploadBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            hideError();
        }

        /**
         * Cancel upload
         */
        function cancelUpload() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileDetails').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('validationResults').style.display = 'none';
        }

        /**
         * Upload file
         */
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            if (!selectedFile) return;

            try {
                document.getElementById('uploadProgress').style.display = 'block';
                document.getElementById('uploadBtn').disabled = true;

                const formData = new FormData();
                formData.append('file', selectedFile);

                const xhr = new XMLHttpRequest();

                // Track upload progress
                xhr.upload.addEventListener('progress', e => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('uploadBar').style.width = percent + '%';
                        document.getElementById('uploadPercent').textContent = percent + '%';
                    }
                });

                // Handle completion
                xhr.addEventListener('load', () => {
                    document.getElementById('uploadProgress').style.display = 'none';

                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        showValidationResults(response);
                        document.getElementById('fileStatus').textContent = 'Uploaded successfully ‚úì';
                        document.getElementById('fileStatus').style.color = 'var(--success-color)';
                        showNotification('File uploaded successfully', 'success');
                        loadRecentUploads();
                    } else {
                        const error = JSON.parse(xhr.responseText);
                        showError(error.detail || 'Upload failed');
                    }

                    document.getElementById('uploadBtn').disabled = false;
                });

                // Handle error
                xhr.addEventListener('error', () => {
                    document.getElementById('uploadProgress').style.display = 'none';
                    showError('Upload failed. Please try again.');
                    document.getElementById('uploadBtn').disabled = false;
                });

                // Send request
                xhr.open('POST', 'http://localhost:8000/api/files/upload');
                xhr.setRequestHeader('Authorization', `Bearer ${localStorage.getItem('access_token')}`);
                xhr.send(formData);
            } catch (error) {
                console.error('Upload error:', error);
                showError('Upload failed: ' + error.message);
                document.getElementById('uploadBtn').disabled = false;
            }
        });

        /**
         * Show validation results
         */
        function showValidationResults(response) {
            const results = document.getElementById('validationResults');
            const content = document.getElementById('validationContent');

            content.innerHTML = `
                <p><strong>Upload ID:</strong> ${response.upload_id}</p>
                <p><strong>Total Records:</strong> ${response.total_records}</p>
                <p><strong>Valid Records:</strong> ${response.valid_records}</p>
                <p><strong>Invalid Records:</strong> ${response.invalid_records}</p>
                <p><strong>Data Quality Score:</strong> ${(response.quality_score * 100).toFixed(1)}%</p>
                ${response.warnings && response.warnings.length > 0 ? `
                    <div style="margin-top: 16px;">
                        <p style="color: var(--warning-color); font-weight: 600;">‚ö†Ô∏è Warnings:</p>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            ${response.warnings.map(w => `<li style="color: var(--gray-dark);">${w}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                <div style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="processUpload('${response.upload_id}')">
                        ‚ñ∂Ô∏è Process & Build Graph
                    </button>
                </div>
            `;

            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Process upload and build graph
         */
        async function processUpload(uploadId) {
            try {
                showNotification('Building knowledge graph...', 'info');
                const response = await api.buildGraph(uploadId);
                showNotification('Graph built successfully', 'success');
                loadRecentUploads();
            } catch (error) {
                console.error('Process error:', error);
                showError('Failed to process upload: ' + error.message);
            }
        }

        /**
         * Load recent uploads
         */
        async function loadRecentUploads() {
            try {
                const uploads = await api.listUploads(0, 20);
                const tbody = document.getElementById('uploadsTable');

                if (uploads && uploads.length > 0) {
                    tbody.innerHTML = uploads
                        .map(
                            upload => `
                        <tr>
                            <td>${upload.filename}</td>
                            <td>${formatDate(upload.upload_date)}</td>
                            <td>
                                <span style="color: ${getStatusColor(upload.status)}; font-weight: 600;">
                                    ${getStatusIcon(upload.status)} ${upload.status}
                                </span>
                            </td>
                            <td>${upload.company_count || '-'}</td>
                            <td>${upload.invoice_count || '-'}</td>
                            <td>
                                <button class="btn btn-small" onclick="viewUploadDetails('${upload.id}')">
                                    View
                                </button>
                                <button class="btn btn-small" onclick="deleteUpload('${upload.id}')" style="background-color: #e74c3c; color: white;">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `,
                        )
                        .join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 20px;">No uploads yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading uploads:', error);
            }
        }

        /**
         * View upload details
         */
        function viewUploadDetails(uploadId) {
            window.location.href = `/upload-details.html?id=${uploadId}`;
        }

        /**
         * Delete upload
         */
        async function deleteUpload(uploadId) {
            if (!confirm('Are you sure you want to delete this upload? This action cannot be undone.')) {
                return;
            }

            try {
                await api.deleteFile(uploadId);
                showNotification('Upload deleted', 'success');
                loadRecentUploads();
            } catch (error) {
                console.error('Delete error:', error);
                showError('Failed to delete upload');
            }
        }

        /**
         * Download template
         */
        function downloadTemplate() {
            const template = `company_name,gstin,revenue,invoice_count
Company A,18AABCT1234H1Z0,1000000,150
Company B,12BCDEF5678G2Z1,2000000,300
Company C,27GHJKL9012M3Z2,500000,75`;

            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(template));
            element.setAttribute('download', 'netra_tax_template.csv');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);

            showNotification('Template downloaded', 'success');
        }

        /**
         * Get status icon
         */
        function getStatusIcon(status) {
            const icons = {
                pending: '‚è≥',
                processing: '‚öôÔ∏è',
                completed: '‚úì',
                failed: '‚úï',
            };
            return icons[status] || '?';
        }

        /**
         * Get status color
         */
        function getStatusColor(status) {
            const colors = {
                pending: '#f39c12',
                processing: '#3498db',
                completed: '#27ae60',
                failed: '#e74c3c',
            };
            return colors[status] || '#172B36';
        }

        /**
         * Format file size
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        /**
         * Show error
         */
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorContent').textContent = message;
            alert.style.display = 'block';
            alert.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Hide error
         */
        function hideError() {
            document.getElementById('errorAlert').style.display = 'none';
        }
    </script>
</body>
</html>
