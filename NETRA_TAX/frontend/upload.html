<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Center - NETRA TAX</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        
        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .upload-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .upload-card h3 {
            color: var(--primary-color, #0F4C5C);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-card h3 i {
            font-size: 20px;
        }
        
        .drop-zone {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 300ms ease-in-out;
            margin-bottom: 16px;
        }
        
        .drop-zone:hover {
            border-color: var(--secondary-color, #FFB703);
            background-color: rgba(255, 183, 3, 0.05);
        }
        
        .drop-zone.dragover {
            border-color: var(--secondary-color, #FFB703);
            background-color: rgba(255, 183, 3, 0.1);
        }
        
        .drop-zone.has-file {
            border-color: #2A9D8F;
            background-color: rgba(42, 157, 143, 0.05);
        }
        
        .drop-zone .icon {
            font-size: 48px;
            margin-bottom: 12px;
            color: #bdc3c7;
        }
        
        .drop-zone.has-file .icon {
            color: #2A9D8F;
        }
        
        .file-info {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
            margin-bottom: 16px;
        }
        
        .file-info.visible {
            display: block;
        }
        
        .file-info p {
            margin: 4px 0;
            font-size: 14px;
        }
        
        .file-info .filename {
            font-weight: 600;
            color: var(--primary-color, #0F4C5C);
        }
        
        .status-message {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
        }
        
        .status-message.success {
            display: block;
            background: rgba(42, 157, 143, 0.1);
            border-left: 4px solid #2A9D8F;
            color: #2A9D8F;
        }
        
        .status-message.error {
            display: block;
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            color: #e74c3c;
        }
        
        .combined-upload {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        
        .upload-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .summary-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .summary-item.companies .icon {
            background: rgba(15, 76, 92, 0.1);
            color: var(--primary-color, #0F4C5C);
        }
        
        .summary-item.invoices .icon {
            background: rgba(255, 183, 3, 0.1);
            color: var(--secondary-color, #FFB703);
        }
        
        .btn-process {
            background: linear-gradient(135deg, #2A9D8F, #34b8a8);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-process:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 157, 143, 0.4);
        }
        
        .btn-process:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            display: none;
            margin-bottom: 16px;
        }
        
        .progress-container.visible {
            display: block;
        }
        
        .progress-bar {
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color, #0F4C5C), var(--secondary-color, #FFB703));
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>ðŸš¨ NETRA TAX</h1>
                <p>AI-Powered Tax Fraud Detection</p>
            </div>
            <ul class="navbar-menu">
                <li><a href="/index.html" class="nav-link">Dashboard</a></li>
                <li><a href="/upload.html" class="nav-link active">Upload</a></li>
                <li><a href="/company-explorer.html" class="nav-link">Companies</a></li>
                <li><a href="/invoice-explorer.html" class="nav-link">Invoices</a></li>
                <li><a href="/graph-visualizer.html" class="nav-link">Network Graph</a></li>
                <li><a href="/reports.html" class="nav-link">Reports</a></li>
                <li><a href="/chatbot.html" class="nav-link">ðŸ¤– AI Assistant</a></li>
                <li>
                    <button class="nav-link" style="background: transparent; border: none; cursor: pointer;" onclick="toggleTheme()" title="Toggle theme">ðŸŒ— Theme</button>
                </li>
                <li class="dropdown">
                    <a href="#" class="nav-link">
                        <i class="fas fa-user"></i> <span id="userDisplay">Admin</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h2>ðŸ“¤ Upload & Process Files</h2>
                <p>Import CSV or Excel files with company and invoice data for fraud detection analysis</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="downloadTemplate()">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
        </div>

        <!-- Two-file Upload Section -->
        <div class="upload-grid">
            <!-- Companies CSV Upload -->
            <div class="upload-card">
                <h3><i class="fas fa-building"></i> Companies Data</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    Required columns: company_id, registration_date, location, turnover, is_fraud<br>
                    <span style="color: #2A9D8F;">Accepts: CSV, Excel (.xlsx, .xls)</span>
                </p>
                
                <div class="drop-zone" id="companiesDropZone">
                    <div class="icon"><i class="fas fa-building"></i></div>
                    <h4>Drag & drop companies file here</h4>
                    <p style="color: #888; font-size: 14px;">or click to browse (CSV, Excel)</p>
                    <input type="file" id="companiesInput" accept=".csv,.xlsx,.xls" style="display: none">
                </div>
                
                <div class="file-info" id="companiesFileInfo">
                    <p><i class="fas fa-file-csv"></i> <span class="filename" id="companiesFileName"></span></p>
                    <p><i class="fas fa-hdd"></i> Size: <span id="companiesFileSize"></span></p>
                </div>
                
                <div class="status-message" id="companiesStatus"></div>
            </div>

            <!-- Invoices CSV Upload -->
            <div class="upload-card">
                <h3><i class="fas fa-file-invoice-dollar"></i> Invoices Data</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    Required columns: invoice_id, seller_id, buyer_id, amount, date, itc_claimed<br>
                    <span style="color: #2A9D8F;">Accepts: CSV, Excel (.xlsx, .xls)</span>
                </p>
                
                <div class="drop-zone" id="invoicesDropZone">
                    <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h4>Drag & drop invoices file here</h4>
                    <p style="color: #888; font-size: 14px;">or click to browse (CSV, Excel)</p>
                    <input type="file" id="invoicesInput" accept=".csv,.xlsx,.xls" style="display: none">
                </div>
                
                <div class="file-info" id="invoicesFileInfo">
                    <p><i class="fas fa-file-csv"></i> <span class="filename" id="invoicesFileName"></span></p>
                    <p><i class="fas fa-hdd"></i> Size: <span id="invoicesFileSize"></span></p>
                </div>
                
                <div class="status-message" id="invoicesStatus"></div>
            </div>
        </div>

        <!-- Combined Upload Section -->
        <div class="combined-upload">
            <h3 style="margin-bottom: 16px; color: var(--primary-color, #0F4C5C);">
                <i class="fas fa-rocket"></i> Upload & Process Data
            </h3>
            
            <div class="upload-summary">
                <div class="summary-item companies">
                    <div class="icon"><i class="fas fa-building"></i></div>
                    <div>
                        <strong>Companies File</strong>
                        <p id="companiesSummary" style="color: #888; font-size: 14px;">No file selected</p>
                    </div>
                </div>
                <div class="summary-item invoices">
                    <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div>
                        <strong>Invoices File</strong>
                        <p id="invoicesSummary" style="color: #888; font-size: 14px;">No file selected</p>
                    </div>
                </div>
            </div>
            
            <div class="progress-container" id="uploadProgress">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Uploading & Processing...</span>
                    <span id="uploadPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="fill" id="uploadBar"></div>
                </div>
            </div>
            
            <div class="status-message" id="uploadStatus"></div>
            
            <button class="btn-process" id="processBtn" onclick="uploadAndProcess()" disabled>
                <i class="fas fa-cloud-upload-alt"></i>
                Upload Files & Train Model
            </button>
        </div>

        <!-- Recent Uploads Section -->
        <div class="table-section">
            <div class="section-header">
                <h3>ðŸ“‹ Data Status</h3>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Companies</th>
                            <th>Invoices</th>
                            <th>Graph Edges</th>
                            <th>Last Update</th>
                        </tr>
                    </thead>
                    <tbody id="uploadsTable">
                        <tr>
                            <td colspan="5" class="text-center" style="padding: 40px; color: #888;">
                                Loading data status...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2026 NETRA TAX - AI-Powered Tax Fraud Detection. All rights reserved.</p>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let companiesFile = null;
        let invoicesFile = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for API detection
            if (api._readyPromise) await api._readyPromise;
            
            setupDropZones();
            loadDataStatus();
        });

        function setupDropZones() {
            // Companies drop zone
            setupSingleDropZone(
                'companiesDropZone',
                'companiesInput',
                'companiesFileInfo',
                'companiesFileName',
                'companiesFileSize',
                'companiesSummary',
                (file) => { companiesFile = file; updateProcessButton(); }
            );

            // Invoices drop zone
            setupSingleDropZone(
                'invoicesDropZone',
                'invoicesInput',
                'invoicesFileInfo',
                'invoicesFileName',
                'invoicesFileSize',
                'invoicesSummary',
                (file) => { invoicesFile = file; updateProcessButton(); }
            );
        }

        function setupSingleDropZone(dropZoneId, inputId, fileInfoId, fileNameId, fileSizeId, summaryId, onFileSelect) {
            const dropZone = document.getElementById(dropZoneId);
            const input = document.getElementById(inputId);
            const fileInfo = document.getElementById(fileInfoId);
            const fileName = document.getElementById(fileNameId);
            const fileSize = document.getElementById(fileSizeId);
            const summary = document.getElementById(summaryId);

            dropZone.addEventListener('click', () => input.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) handleFile(files[0]);
            });

            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleFile(e.target.files[0]);
            });

            function handleFile(file) {
                if (!file.name.endsWith('.csv')) {
                    alert('Please select a CSV file');
                    return;
                }

                dropZone.classList.add('has-file');
                fileInfo.classList.add('visible');
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                summary.textContent = `${file.name} (${formatFileSize(file.size)})`;
                
                onFileSelect(file);
            }
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            btn.disabled = !(companiesFile && invoicesFile);
        }

        async function uploadAndProcess() {
            if (!companiesFile || !invoicesFile) {
                showStatus('uploadStatus', 'Please select both companies and invoices files', 'error');
                return;
            }

            const btn = document.getElementById('processBtn');
            const progress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadBar');
            const progressPercent = document.getElementById('uploadPercent');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            progress.classList.add('visible');

            try {
                const formData = new FormData();
                formData.append('companies_file', companiesFile);
                formData.append('invoices_file', invoicesFile);

                // Use XMLHttpRequest for progress tracking
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressPercent.textContent = percent + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    progress.classList.remove('visible');
                    
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        showStatus('uploadStatus', 
                            `âœ“ Upload successful! Processed ${response.total_rows || 'N/A'} records. Model training initiated.`, 
                            'success');
                        
                        // Reset files
                        resetUploadForm();
                        loadDataStatus();
                    } else {
                        let errorMsg = 'Upload failed';
                        try {
                            const error = JSON.parse(xhr.responseText);
                            errorMsg = error.error || error.detail || errorMsg;
                        } catch (e) {}
                        showStatus('uploadStatus', errorMsg, 'error');
                    }
                    
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Files & Train Model';
                    updateProcessButton();
                });

                xhr.addEventListener('error', () => {
                    progress.classList.remove('visible');
                    showStatus('uploadStatus', 'Upload failed. Please check your connection and try again.', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Files & Train Model';
                });

                xhr.open('POST', `${api.baseURL}/api/upload_data`);
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                showStatus('uploadStatus', 'Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Files & Train Model';
                progress.classList.remove('visible');
            }
        }

        function resetUploadForm() {
            companiesFile = null;
            invoicesFile = null;
            document.getElementById('companiesDropZone').classList.remove('has-file');
            document.getElementById('invoicesDropZone').classList.remove('has-file');
            document.getElementById('companiesFileInfo').classList.remove('visible');
            document.getElementById('invoicesFileInfo').classList.remove('visible');
            document.getElementById('companiesSummary').textContent = 'No file selected';
            document.getElementById('invoicesSummary').textContent = 'No file selected';
            document.getElementById('companiesInput').value = '';
            document.getElementById('invoicesInput').value = '';
        }

        async function loadDataStatus() {
            try {
                const stats = await api.getStatistics();
                const tbody = document.getElementById('uploadsTable');
                
                if (stats && stats.total_companies > 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td><span style="color: #2A9D8F; font-weight: 600;"><i class="fas fa-check-circle"></i> Active</span></td>
                            <td><strong>${stats.total_companies.toLocaleString()}</strong></td>
                            <td><strong>${stats.total_invoices ? stats.total_invoices.toLocaleString() : 'N/A'}</strong></td>
                            <td>${stats.total_edges ? stats.total_edges.toLocaleString() : 'N/A'}</td>
                            <td>${new Date().toLocaleString()}</td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center" style="padding: 40px; color: #888;">
                                No data loaded yet. Upload companies and invoices CSV files to start.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading data status:', error);
                document.getElementById('uploadsTable').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: #e74c3c;">
                            Could not connect to backend. Make sure the server is running.
                        </td>
                    </tr>
                `;
            }
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'status-message ' + type;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadTemplate() {
            // Create sample CSV templates
            const companiesTemplate = `company_id,registration_date,location,turnover,is_fraud
COMP001,2020-01-15,Delhi,5000000,0
COMP002,2019-06-22,Mumbai,12000000,0
COMP003,2021-03-10,Chennai,3500000,1`;

            const invoicesTemplate = `invoice_id,seller_id,buyer_id,amount,date,itc_claimed
INV001,COMP001,COMP002,150000,2024-01-15,1
INV002,COMP002,COMP003,280000,2024-01-18,1
INV003,COMP003,COMP001,95000,2024-01-20,0`;

            // Download companies template
            const companiesBlob = new Blob([companiesTemplate], { type: 'text/csv' });
            const companiesUrl = URL.createObjectURL(companiesBlob);
            const a1 = document.createElement('a');
            a1.href = companiesUrl;
            a1.download = 'companies_template.csv';
            a1.click();

            // Download invoices template after a small delay
            setTimeout(() => {
                const invoicesBlob = new Blob([invoicesTemplate], { type: 'text/csv' });
                const invoicesUrl = URL.createObjectURL(invoicesBlob);
                const a2 = document.createElement('a');
                a2.href = invoicesUrl;
                a2.download = 'invoices_template.csv';
                a2.click();
            }, 500);
        }
    </script>
</body>
</html>
