<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Explorer - NETRA TAX</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>üîê NETRA TAX</h1>
                <p>Tax Fraud Detection</p>
            </div>
            <ul class="navbar-menu">
                <li><a href="/index.html" class="nav-link">üìä Dashboard</a></li>
                <li><a href="/upload.html" class="nav-link">üì§ Upload</a></li>
                <li><a href="/company-explorer.html" class="nav-link">üè¢ Companies</a></li>
                <li><a href="/invoice-explorer.html" class="nav-link active">üìÑ Invoices</a></li>
                <li><a href="/graph-visualizer.html" class="nav-link">üï∏Ô∏è Network</a></li>
                <li><a href="/reports.html" class="nav-link">üìë Reports</a></li>
                <li><a href="/admin.html" class="nav-link">‚öôÔ∏è Admin</a></li>
                <li>
                    <div class="dropdown">
                        <a href="#" class="nav-link">üë§ <span class="user-name">User</span></a>
                        <div class="dropdown-menu user-dropdown"></div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h2>üìÑ Invoice Explorer</h2>
                <p>Search and analyze invoices for fraud indicators</p>
            </div>
            <div class="header-actions">
                <input type="text" id="searchInput" placeholder="Search by invoice ID, GSTIN..." style="padding: 10px 16px; border: 1px solid #bdc3c7; border-radius: 8px; width: 300px;" />
                <button class="btn btn-primary" onclick="performSearch()">üîç Search</button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="table-section" style="margin-bottom: 24px;">
            <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--primary-color); font-weight: 600;">Filters</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                    <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; display: block;">Risk Level</label>
                    <select id="riskFilter" onchange="performSearch()" style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px;">
                        <option value="">All Levels</option>
                        <option value="high">High Risk</option>
                        <option value="medium">Medium Risk</option>
                        <option value="low">Low Risk</option>
                    </select>
                </div>

                <div>
                    <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; display: block;">Date Range</label>
                    <select id="dateFilter" onchange="performSearch()" style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px;">
                        <option value="">All Dates</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>

                <div>
                    <label style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px; display: block;">Amount Range</label>
                    <select id="amountFilter" onchange="performSearch()" style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 8px;">
                        <option value="">All Amounts</option>
                        <option value="0,100000">Under 1 Lakh</option>
                        <option value="100000,1000000">1-10 Lakh</option>
                        <option value="1000000,10000000">10 Lakh - 1 Crore</option>
                        <option value="10000000,999999999">Above 1 Crore</option>
                    </select>
                </div>

                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%;">Clear Filters</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="table-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 16px; color: var(--primary-color); font-weight: 600;">Search Results</h3>
                <span id="resultCount" style="color: var(--gray-dark);">0 results</span>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Invoice ID</th>
                            <th>From (GSTIN)</th>
                            <th>To (GSTIN)</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Date</th>
                            <th>Risk Score</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable">
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px;">
                                <p style="color: var(--gray-medium); margin-bottom: 16px;">Enter a search query to get started</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination" style="display: none; text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid #ecf0f1;">
                <button class="btn btn-small" id="prevBtn" onclick="previousPage()">‚Üê Previous</button>
                <span id="pageInfo" style="margin: 0 16px; color: var(--gray-dark);"></span>
                <button class="btn btn-small" id="nextBtn" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>

        <!-- Invoice Detail Modal -->
        <div id="invoiceModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="modal-close" onclick="closeModal()">&times;</span>

                <div id="invoiceDetail">
                    <h3 style="font-size: 20px; color: var(--primary-color); margin-bottom: 24px;">Invoice Details</h3>

                    <div style="background-color: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Invoice ID</p>
                                <p id="detailInvoiceId" style="font-weight: 600; font-size: 16px;"></p>
                            </div>
                            <div>
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Invoice Date</p>
                                <p id="detailDate" style="font-weight: 600; font-size: 16px;"></p>
                            </div>
                            <div>
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Amount</p>
                                <p id="detailAmount" style="font-weight: 600; font-size: 16px;"></p>
                            </div>
                            <div>
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">GST Amount</p>
                                <p id="detailGST" style="font-weight: 600; font-size: 16px;"></p>
                            </div>
                        </div>
                    </div>

                    <h4 style="color: var(--primary-color); margin-bottom: 12px;">Party Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                        <div>
                            <p style="color: var(--gray-dark); font-size: 12px; font-weight: 600; margin-bottom: 8px;">From (Supplier)</p>
                            <div style="background-color: var(--light-bg); padding: 12px; border-radius: 8px;">
                                <p id="detailFromGstin" style="font-weight: 600;"></p>
                                <p id="detailFromName" style="color: var(--gray-dark); font-size: 13px;"></p>
                                <p id="detailFromRisk" style="color: var(--gray-dark); font-size: 13px; margin-top: 4px;"></p>
                            </div>
                        </div>
                        <div>
                            <p style="color: var(--gray-dark); font-size: 12px; font-weight: 600; margin-bottom: 8px;">To (Recipient)</p>
                            <div style="background-color: var(--light-bg); padding: 12px; border-radius: 8px;">
                                <p id="detailToGstin" style="font-weight: 600;"></p>
                                <p id="detailToName" style="color: var(--gray-dark); font-size: 13px;"></p>
                                <p id="detailToRisk" style="color: var(--gray-dark); font-size: 13px; margin-top: 4px;"></p>
                            </div>
                        </div>
                    </div>

                    <h4 style="color: var(--primary-color); margin-bottom: 12px;">Fraud Risk Assessment</h4>
                    <div style="background-color: var(--light-bg); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div style="text-align: center;">
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Risk Score</p>
                                <p id="detailRiskScore" style="font-weight: 600; font-size: 20px; color: var(--danger-color);">-</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Risk Level</p>
                                <p id="detailRiskLevel" style="font-weight: 600; font-size: 16px;">-</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Status</p>
                                <p id="detailStatus" style="font-weight: 600; font-size: 14px;">-</p>
                            </div>
                        </div>
                    </div>

                    <h4 style="color: var(--primary-color); margin-bottom: 12px;">Risk Indicators</h4>
                    <div id="riskIndicators" style="background-color: var(--light-bg); padding: 16px; border-radius: 8px;">
                        <!-- Risk indicators will be populated here -->
                    </div>
                </div>

                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="flagInvoice()">üö© Flag for Review</button>
                    <button class="btn" style="background-color: #bdc3c7; color: white;" onclick="closeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2024 NETRA TAX - AI-Powered Tax Fraud Detection. All rights reserved.</p>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let currentPage = 0;
        let pageSize = 20;
        let currentInvoice = null;
        let searchResults = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            requireAuth();
            await loadUserInfo();
        });

        /**
         * Load user info
         */
        async function loadUserInfo() {
            try {
                const user = getCurrentUser();
                if (!user) {
                    const response = await api.getCurrentUser();
                    setCurrentUser(response);
                    updateUserDropdown(response);
                } else {
                    updateUserDropdown(user);
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        /**
         * Update user dropdown
         */
        function updateUserDropdown(user) {
            const userNameElement = document.querySelector('.user-name');
            const userDropdown = document.querySelector('.user-dropdown');

            if (userNameElement) userNameElement.textContent = user.full_name || user.username;

            if (userDropdown) {
                userDropdown.innerHTML = `
                    <a href="/profile.html">üë§ My Profile</a>
                    <a href="/settings.html">‚öôÔ∏è Settings</a>
                    <hr style="margin: 8px 0; border: none; border-top: 1px solid #ecf0f1;">
                    <a onclick="logoutUser()" style="cursor: pointer;">üö™ Logout</a>
                `;
            }
        }

        /**
         * Perform search
         */
        async function performSearch() {
            try {
                currentPage = 0;
                const query = document.getElementById('searchInput').value.trim();

                if (!query) {
                    showNotification('Please enter a search query', 'warning');
                    return;
                }

                showSpinner(document.getElementById('invoicesTable').parentElement);

                const response = await api.searchInvoices(query, 0, pageSize);
                searchResults = response || [];

                displayResults();
                hideSpinner();
            } catch (error) {
                console.error('Search error:', error);
                showNotification('Search failed: ' + error.message, 'error');
                hideSpinner();
            }
        }

        /**
         * Display search results
         */
        function displayResults() {
            const tbody = document.getElementById('invoicesTable');
            const resultCount = document.getElementById('resultCount');

            if (searchResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center" style="padding: 40px;">No invoices found</td></tr>';
                resultCount.textContent = '0 results';
                return;
            }

            const start = currentPage * pageSize;
            const end = start + pageSize;
            const pageResults = searchResults.slice(start, end);

            tbody.innerHTML = pageResults
                .map(
                    invoice => {
                        const riskBadge = getRiskLevelBadge(invoice.risk_score);
                        return `
                <tr>
                    <td>${invoice.id || '-'}</td>
                    <td>${invoice.from_gstin || '-'}</td>
                    <td>${invoice.to_gstin || '-'}</td>
                    <td>${formatCurrency(invoice.amount || 0)}</td>
                    <td>${formatDate(invoice.date) || '-'}</td>
                    <td>
                        <span style="color: ${riskBadge.color}; font-weight: 600;">
                            ${invoice.risk_score ? invoice.risk_score.toFixed(2) : '-'}
                        </span>
                    </td>
                    <td>
                        <span style="color: ${riskBadge.color}; font-weight: 600;">
                            ${riskBadge.icon} ${riskBadge.level}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small" onclick="viewInvoiceDetails('${invoice.id}')">View</button>
                    </td>
                </tr>
            `;
                    },
                )
                .join('');

            resultCount.textContent = searchResults.length + ' results';

            // Show pagination if needed
            const pagination = document.getElementById('pagination');
            if (searchResults.length > pageSize) {
                pagination.style.display = 'block';
                document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${Math.ceil(searchResults.length / pageSize)}`;
                document.getElementById('prevBtn').disabled = currentPage === 0;
                document.getElementById('nextBtn').disabled = end >= searchResults.length;
            } else {
                pagination.style.display = 'none';
            }
        }

        /**
         * View invoice details
         */
        async function viewInvoiceDetails(invoiceId) {
            try {
                const modal = document.getElementById('invoiceModal');
                showSpinner(modal);

                const invoice = searchResults.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                currentInvoice = invoice;

                // Update basic details
                document.getElementById('detailInvoiceId').textContent = invoice.id;
                document.getElementById('detailDate').textContent = formatDate(invoice.date);
                document.getElementById('detailAmount').textContent = formatCurrency(invoice.amount);
                document.getElementById('detailGST').textContent = formatCurrency(invoice.gst_amount || 0);

                // Party details
                document.getElementById('detailFromGstin').textContent = invoice.from_gstin;
                document.getElementById('detailFromName').textContent = invoice.from_name || 'Unknown';
                document.getElementById('detailFromRisk').textContent = `Risk: ${getRiskLevelBadge(invoice.from_risk_score).level}`;

                document.getElementById('detailToGstin').textContent = invoice.to_gstin;
                document.getElementById('detailToName').textContent = invoice.to_name || 'Unknown';
                document.getElementById('detailToRisk').textContent = `Risk: ${getRiskLevelBadge(invoice.to_risk_score).level}`;

                // Risk assessment
                const riskBadge = getRiskLevelBadge(invoice.risk_score);
                document.getElementById('detailRiskScore').textContent = invoice.risk_score?.toFixed(2) || '-';
                document.getElementById('detailRiskScore').style.color = riskBadge.color;
                document.getElementById('detailRiskLevel').textContent = riskBadge.icon + ' ' + riskBadge.level;
                document.getElementById('detailStatus').textContent = invoice.flagged ? 'üö© Flagged' : '‚úì Normal';

                // Risk indicators
                const indicatorsDiv = document.getElementById('riskIndicators');
                if (invoice.risk_indicators && invoice.risk_indicators.length > 0) {
                    indicatorsDiv.innerHTML = invoice.risk_indicators
                        .map(
                            indicator => `
                        <div style="padding: 8px; margin-bottom: 8px; background: var(--white); border-left: 3px solid var(--warning-color); border-radius: 4px;">
                            <p style="font-weight: 600; color: var(--dark);">${indicator.name}</p>
                            <p style="color: var(--gray-dark); font-size: 13px;">${indicator.description}</p>
                        </div>
                    `,
                        )
                        .join('');
                } else {
                    indicatorsDiv.innerHTML = '<p style="color: var(--gray-medium);">No specific risk indicators detected</p>';
                }

                hideSpinner();
                modal.classList.add('open');
            } catch (error) {
                console.error('Error loading invoice details:', error);
                showNotification('Failed to load invoice details', 'error');
                hideSpinner();
            }
        }

        /**
         * Flag invoice for review
         */
        async function flagInvoice() {
            if (!currentInvoice) return;

            try {
                showNotification('Flagging invoice...', 'info');

                // In a real implementation, this would call an API
                // For now, just update the UI
                currentInvoice.flagged = true;
                document.getElementById('detailStatus').textContent = 'üö© Flagged';

                showNotification('Invoice flagged for review', 'success');
            } catch (error) {
                console.error('Flagging error:', error);
                showNotification('Failed to flag invoice', 'error');
            }
        }

        /**
         * Close modal
         */
        function closeModal() {
            document.getElementById('invoiceModal').classList.remove('open');
        }

        /**
         * Pagination
         */
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                displayResults();
                window.scrollTo(0, 0);
            }
        }

        function nextPage() {
            if ((currentPage + 1) * pageSize < searchResults.length) {
                currentPage++;
                displayResults();
                window.scrollTo(0, 0);
            }
        }

        /**
         * Clear filters
         */
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('riskFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('amountFilter').value = '';
            document.getElementById('invoicesTable').innerHTML = '<tr><td colspan="8" class="text-center" style="padding: 40px;">Enter a search query to get started</td></tr>';
        }
    </script>
</body>
</html>
