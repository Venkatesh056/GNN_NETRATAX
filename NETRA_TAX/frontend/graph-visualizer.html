<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Graph Visualizer - NETRA TAX</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .graph-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            height: 600px;
        }

        .graph-main {
            flex: 1;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        #graph {
            width: 100%;
            height: 100%;
        }

        .graph-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--pearl-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: var(--pearl);
            transform: translateY(-2px);
        }

        .legend-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            z-index: 10;
            width: 180px;
            backdrop-filter: blur(4px);
        }

        .legend-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--navy);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
                            <div class="legend-color" style="background: var(--critical-red);"></div>

        .legend-color {
            width: 12px;
                            <div class="legend-color" style="background: var(--warning-orange);"></div>
            border-radius: 50%;
        }

                            <div class="legend-color" style="background: var(--safe-green);"></div>
            width: 20px;
            height: 2px;
        }
                            <div class="legend-color" style="background: var(--info-blue); border: 2px solid white;"></div>
        .sidebar-panel {
            width: 350px;
            background: var(--white);
                            <div class="legend-line" style="background: var(--critical-red);"></div>
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
                            <div class="legend-line" style="background: var(--border-light);"></div>
        }

        .sidebar-header {
            padding: 20px;
            background: var(--navy);
            color: white;
        }

        .sidebar-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .node-highlight {
            stroke: #3498db;
            stroke-width: 4px;
        }

        .link-fraud {
            stroke: #e74c3c;
            stroke-width: 2px;
            stroke-dasharray: 4;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(47, 65, 86, 0.9);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 12px;
            z-index: 100;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <span class="brand-netra">NETRA</span><span class="brand-tax">TAX</span>
            </div>
            <ul class="navbar-menu">
                <li><a href="/index.html" class="nav-link">Dashboard</a></li>
                <li><a href="/company-explorer.html" class="nav-link">Companies</a></li>
                <li><a href="/invoice-explorer.html" class="nav-link">Invoices</a></li>
                <li><a href="/graph-visualizer.html" class="nav-link active">Network</a></li>
                <li><a href="/chatbot.html" class="nav-link">ðŸ¤– AI Assistant</a></li>
                <li><button class="nav-link" style="background: transparent; border: none; cursor: pointer;" onclick="toggleTheme()" title="Toggle theme">ðŸŒ— Theme</button></li>
                <li><a href="/upload.html" class="nav-link">Upload</a></li>
            </ul>
            <div class="navbar-user">
                <span id="userDisplay">Admin</span>
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h2>Network Visualizer</h2>
                <p>Map connections and identify circular trading patterns</p>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group" style="flex: 1;">
                    <label class="filter-label">Search and Center GSTIN</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="centerNodeInput" class="filter-input" placeholder="Enter GSTIN...">
                        <button class="btn btn-primary" onclick="loadGraphByGSTIN()"
                            style="white-space: nowrap;">Locate</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Max. Depth</label>
                    <select id="depthFilter" class="filter-select">
                        <option value="1">1st Degree</option>
                        <option value="2" selected>2nd Degree</option>
                        <option value="3">3rd Degree</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Visualizer Area -->
        <div class="graph-wrapper">
            <div class="graph-main">
                <div class="graph-controls">
                    <button class="control-btn" onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
                    <button class="control-btn" onclick="zoomOut()" title="Zoom Out"><i
                            class="fas fa-minus"></i></button>
                    <button class="control-btn" onclick="resetZoom()" title="Reset View"><i
                            class="fas fa-crosshairs"></i></button>
                </div>

                <svg id="graph"></svg>

                <div class="legend-overlay">
                    <div class="legend-title">Legend</div>
                    <div class="legend-item">
                        <div class="legend-color high"></div>
                        <span>High Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color medium"></div>
                        <span>Medium Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color low"></div>
                        <span>Low Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color info" style="border: 2px solid white;"></div>
                        <span>Center Node</span>
                    </div>
                    <div style="height: 1px; background: #eee; margin: 8px 0;"></div>
                    <div class="legend-item">
                        <div class="legend-line fraud"></div>
                        <span>Fraud Ring Link</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line normal"></div>
                        <span>Normal Link</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-panel">
                <div class="sidebar-header">
                    <h3 style="font-size: 16px; font-weight: 700;">Selected Entity</h3>
                </div>
                <div id="entityDetails" class="sidebar-content">
                    <div class="empty-state" style="text-align: center; margin-top: 40px; color: #999;">
                        <i class="fas fa-mouse-pointer" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Click a node in the graph to view detailed risk information.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Nodes</div>
                <div class="metric-value" id="graphNodes">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Edges</div>
                <div class="metric-value" id="graphEdges">0</div>
            </div>
            <div class="metric-card alert-card">
                <div class="metric-label">Avg. Risk Score</div>
                <div class="metric-value" id="graphAvgRisk">0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Identified Clusters</div>
                <div class="metric-value" id="graphClusters">0</div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip" style="display: none;"></div>

    <script src="/js/api.js"></script>
    <script>
        let graphData = null;
        let simulation = null;
        let selectedNode = null;
        let svg = null;
        let g = null;
        let zoomHandler = null;

        document.addEventListener('DOMContentLoaded', async () => {
            svg = d3.select('#graph');
            const container = svg.node().parentElement;

            // Set SVG size
            svg.attr('width', container.offsetWidth)
                .attr('height', container.offsetHeight);

            // Add zoom behavior
            zoomHandler = d3.zoom()
                .scaleExtent([0.1, 8])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoomHandler);
            g = svg.append('g');

            // Load initial graph
            loadDefaultGraph();
        });

        async function loadDefaultGraph() {
            try {
                const response = await api.getNetworkGraph();
                renderGraph(response);
            } catch (e) {
                console.error('Failed to load graph:', e);
                const container = document.getElementById('entityDetails');
                container.innerHTML = '<div class="error-state"><p>Graph data unavailable</p></div>';
            }
        }

        async function loadGraphByGSTIN() {
            const gstin = document.getElementById('centerNodeInput').value.trim();
            if (!gstin) return;

            try {
                // For demo, we might use a filtered version or different endpoint
                const response = await api.request(`/api/network-graph?center=${gstin}`);
                renderGraph(response, gstin);
            } catch (e) {
                console.error('Search failed:', e);
            }
        }

        function renderGraph(data, centerGstin = null) {
            if (!data || !data.nodes) return;
            graphData = data;

            // Clear previous graph
            g.selectAll('*').remove();

            // Update metrics
            document.getElementById('graphNodes').textContent = data.nodes.length;
            document.getElementById('graphEdges').textContent = data.links.length;
            const avgRisk = data.nodes.reduce((acc, n) => acc + (n.risk || 0), 0) / data.nodes.length;
            document.getElementById('graphAvgRisk').textContent = avgRisk.toFixed(2);
            document.getElementById('graphClusters').textContent = Math.floor(data.nodes.length / 5);

            // Setup simulation
            simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(svg.attr('width') / 2, svg.attr('height') / 2));

            // Links
            const link = g.append('g')
                .selectAll('line')
                .data(data.links)
                .enter().append('line')
                .attr('stroke', getComputedStyle(document.documentElement).getPropertyValue('--border-light').trim() || '#ccc')
                .attr('stroke-width', d => Math.max(1.5, Math.min(4, (d.value || 1) / 100000)))
                .attr('class', d => d.isFraudRing ? 'link-fraud' : '');

            // Nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter().append('circle')
                .attr('r', d => d.id === centerGstin ? 14 : 8)
                .attr('fill', d => {
                    const styles = getComputedStyle(document.documentElement);
                    const info = styles.getPropertyValue('--info-blue').trim() || '#3498db';
                    const high = styles.getPropertyValue('--critical-red').trim() || '#e74c3c';
                    const med = styles.getPropertyValue('--warning-orange').trim() || '#f39c12';
                    const low = styles.getPropertyValue('--safe-green').trim() || '#27ae60';
                    if (d.id === centerGstin) return info;
                    if (d.risk > 0.7) return high;
                    if (d.risk > 0.4) return med;
                    return low;
                })
                .attr('class', d => d.id === centerGstin ? 'node-highlight' : '')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('click', (e, d) => showDetails(d))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('cx', d => d.x)
                    .attr('cy', d => d.y);
            });
        }

        function showDetails(node) {
            const container = document.getElementById('entityDetails');
            container.innerHTML = `
                <div class="detail-card">
                    <p style="color: #666; font-size: 12px;">ID / GSTIN</p>
                    <p style="font-weight: 700; margin-bottom: 20px; font-size: 16px; color: var(--navy);">${node.id}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <p style="color: #666; font-size: 12px;">Risk Score</p>
                            <p style="font-weight: 700; font-size: 18px;">${(node.risk * 100).toFixed(1)}%</p>
                        </div>
                        <div>
                            <p style="color: #666; font-size: 12px;">Risk Level</p>
                            <span class="status-badge ${node.risk > 0.7 ? 'badge-flagged' : (node.risk > 0.4 ? 'badge-review' : 'badge-clear')}">
                                ${node.risk > 0.7 ? 'High' : (node.risk > 0.4 ? 'Medium' : 'Low')}
                            </span>
                        </div>
                    </div>
                    
                    <p style="color: #666; font-size: 12px;">Network Importance</p>
                    <p style="font-weight: 600; margin-bottom: 20px;">Centrality Degree: ${node.degree || 'N/A'}</p>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" 
                        onclick="window.location.href='/company-explorer.html?search=${node.id}'">
                        View Full History
                    </button>
                </div>
            `;
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.innerHTML = `<strong>${d.id}</strong><br>Risk: ${(d.risk * 100).toFixed(1)}%`;
            updateTooltipPosition(event);
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function updateTooltipPosition(event) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function zoomIn() { svg.transition().call(zoomHandler.scaleBy, 1.3); }
        function zoomOut() { svg.transition().call(zoomHandler.scaleBy, 0.7); }
        function resetZoom() { svg.transition().call(zoomHandler.transform, d3.zoomIdentity); }

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        // Removed synthetic fallback data per production requirements
    </script>
</body>

</html>