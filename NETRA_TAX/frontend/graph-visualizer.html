<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Graph Visualizer - NETRA TAX</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .graph-container {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 24px;
        }

        #graph {
            width: 100%;
            height: 600px;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
        }

        .node:hover {
            stroke-width: 3px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node-label {
            font-size: 12px;
            pointer-events: none;
            user-select: none;
            text-anchor: middle;
        }

        .tooltip {
            position: absolute;
            padding: 12px;
            background: var(--dark);
            color: var(--white);
            border-radius: 8px;
            pointer-events: none;
            z-index: 999;
            font-size: 12px;
            max-width: 250px;
            box-shadow: var(--shadow-lg);
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--white);
            padding: 16px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .controls {
            padding: 16px;
            background: var(--light-bg);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            border-bottom: 1px solid #ecf0f1;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .control-group input[type='range'] {
            width: 120px;
        }

        .info-panel {
            background: var(--light-bg);
            padding: 16px;
            border-top: 1px solid #ecf0f1;
            display: none;
        }

        .info-panel.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>üîê NETRA TAX</h1>
                <p>Tax Fraud Detection</p>
            </div>
            <ul class="navbar-menu">
                <li><a href="/index.html" class="nav-link">üìä Dashboard</a></li>
                <li><a href="/upload.html" class="nav-link">üì§ Upload</a></li>
                <li><a href="/company-explorer.html" class="nav-link">üè¢ Companies</a></li>
                <li><a href="/invoice-explorer.html" class="nav-link">üìÑ Invoices</a></li>
                <li><a href="/graph-visualizer.html" class="nav-link active">üï∏Ô∏è Network</a></li>
                <li><a href="/reports.html" class="nav-link">üìë Reports</a></li>
                <li><a href="/admin.html" class="nav-link">‚öôÔ∏è Admin</a></li>
                <li>
                    <div class="dropdown">
                        <a href="#" class="nav-link">üë§ <span class="user-name">User</span></a>
                        <div class="dropdown-menu user-dropdown"></div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h2>üï∏Ô∏è Network Graph Visualizer</h2>
                <p>Visualize company connections and fraud ring patterns</p>
            </div>
            <div class="header-actions">
                <input type="text" id="centerNodeInput" placeholder="Enter GSTIN to center on..." style="padding: 10px 16px; border: 1px solid #bdc3c7; border-radius: 8px; width: 250px;" />
                <button class="btn btn-primary" onclick="loadGraphByGSTIN()">Load</button>
            </div>
        </div>

        <!-- Graph Container -->
        <div class="graph-container">
            <div class="controls">
                <div class="control-group">
                    <label>Zoom Level:</label>
                    <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1" onchange="updateZoom()" />
                </div>

                <div class="control-group">
                    <label>Link Distance:</label>
                    <input type="range" id="linkDistance" min="20" max="200" step="10" value="100" onchange="updateSimulation()" />
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showLabels" checked onchange="toggleLabels()" />
                        Show Labels
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="highlightRiskRings" checked onchange="toggleFraudRings()" />
                        Highlight Fraud Rings
                    </label>
                </div>

                <button class="btn btn-secondary" onclick="resetGraph()">‚Üª Reset View</button>
                <button class="btn btn-secondary" onclick="downloadGraph()">‚¨á Download PNG</button>
            </div>

            <svg id="graph"></svg>

            <div class="legend">
                <div style="font-weight: 600; margin-bottom: 12px; color: var(--primary-color);">Legend</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>High Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>Medium Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>Low Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>Center Node</span>
                </div>
                <div style="border-top: 1px solid #ecf0f1; margin: 12px 0;"></div>
                <div class="legend-item">
                    <div style="width: 30px; height: 2px; background: #c0392b;"></div>
                    <span>Fraud Ring Link</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 2px; background: #999;"></div>
                    <span>Normal Link</span>
                </div>
            </div>

            <div id="tooltip" class="tooltip" style="display: none;"></div>
        </div>

        <!-- Selected Node Info Panel -->
        <div id="infoPanel" class="info-panel">
            <h3 style="color: var(--primary-color); margin-bottom: 16px;">Selected Node Information</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                <div>
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">GSTIN</p>
                    <p id="infoPanelGstin" style="font-weight: 600;"></p>
                </div>
                <div>
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Company Name</p>
                    <p id="infoPanelName" style="font-weight: 600;"></p>
                </div>
                <div>
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Risk Score</p>
                    <p id="infoPanelRisk" style="font-weight: 600;"></p>
                </div>
                <div>
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">Connected Companies</p>
                    <p id="infoPanelConnected" style="font-weight: 600;"></p>
                </div>
                <div>
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 4px;">In Fraud Ring</p>
                    <p id="infoPanelFraudRing" style="font-weight: 600;"></p>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-primary" onclick="viewCompanyDetails()">View Full Details ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="table-section">
            <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--primary-color); font-weight: 600;">Graph Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div style="background: var(--light-bg); padding: 16px; border-radius: 8px;">
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 8px;">Total Nodes</p>
                    <p id="totalNodes" style="font-weight: 600; font-size: 20px; color: var(--primary-color);">0</p>
                </div>
                <div style="background: var(--light-bg); padding: 16px; border-radius: 8px;">
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 8px;">Total Connections</p>
                    <p id="totalConnections" style="font-weight: 600; font-size: 20px; color: var(--info-color);">0</p>
                </div>
                <div style="background: var(--light-bg); padding: 16px; border-radius: 8px;">
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 8px;">Fraud Rings Detected</p>
                    <p id="fraudRingsCount" style="font-weight: 600; font-size: 20px; color: var(--danger-color);">0</p>
                </div>
                <div style="background: var(--light-bg); padding: 16px; border-radius: 8px;">
                    <p style="color: var(--gray-dark); font-size: 12px; margin-bottom: 8px;">Network Density</p>
                    <p id="networkDensity" style="font-weight: 600; font-size: 20px; color: var(--warning-color);">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2024 NETRA TAX - AI-Powered Tax Fraud Detection. All rights reserved.</p>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let graphData = null;
        let simulation = null;
        let selectedNode = null;
        let svg = null;
        let g = null;
        let currentZoom = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            requireAuth();
            await loadUserInfo();

            // Check for center node parameter
            const params = new URLSearchParams(window.location.search);
            const center = params.get('center');
            if (center) {
                document.getElementById('centerNodeInput').value = center;
                loadGraphByGSTIN();
            } else {
                loadDefaultGraph();
            }
        });

        /**
         * Load user info
         */
        async function loadUserInfo() {
            try {
                const user = getCurrentUser();
                if (!user) {
                    const response = await api.getCurrentUser();
                    setCurrentUser(response);
                    updateUserDropdown(response);
                } else {
                    updateUserDropdown(user);
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        /**
         * Update user dropdown
         */
        function updateUserDropdown(user) {
            const userNameElement = document.querySelector('.user-name');
            const userDropdown = document.querySelector('.user-dropdown');

            if (userNameElement) userNameElement.textContent = user.full_name || user.username;

            if (userDropdown) {
                userDropdown.innerHTML = `
                    <a href="/profile.html">üë§ My Profile</a>
                    <a href="/settings.html">‚öôÔ∏è Settings</a>
                    <hr style="margin: 8px 0; border: none; border-top: 1px solid #ecf0f1;">
                    <a onclick="logoutUser()" style="cursor: pointer;">üö™ Logout</a>
                `;
            }
        }

        /**
         * Load default graph
         */
        async function loadDefaultGraph() {
            try {
                showNotification('Loading network graph...', 'info');

                // Create sample graph data
                graphData = generateSampleGraphData();
                renderGraph();
                updateGraphStats();

                hideSpinner();
            } catch (error) {
                console.error('Error loading graph:', error);
                showNotification('Failed to load graph', 'error');
            }
        }

        /**
         * Load graph by GSTIN
         */
        async function loadGraphByGSTIN() {
            try {
                const gstin = document.getElementById('centerNodeInput').value.trim();
                if (!gstin) {
                    showNotification('Please enter a GSTIN', 'warning');
                    return;
                }

                showNotification('Loading network graph...', 'info');

                // Load network analysis
                const analysis = await api.getNetworkAnalysis(gstin);

                // Create graph from network analysis
                graphData = {
                    nodes: analysis.nodes || [],
                    links: analysis.links || [],
                    centerNode: gstin,
                };

                renderGraph();
                updateGraphStats();
            } catch (error) {
                console.error('Error loading graph:', error);
                showNotification('Failed to load graph for GSTIN', 'error');
            }
        }

        /**
         * Generate sample graph data for demonstration
         */
        function generateSampleGraphData() {
            const companies = [
                { gstin: '18AABCT1234H1Z0', name: 'Company A', risk: 0.85 },
                { gstin: '12BCDEF5678G2Z1', name: 'Company B', risk: 0.72 },
                { gstin: '27GHJKL9012M3Z2', name: 'Company C', risk: 0.45 },
                { gstin: '05MNOPQ3456N4Z3', name: 'Company D', risk: 0.38 },
                { gstin: '14RSTU7890P5Z4', name: 'Company E', risk: 0.92 },
                { gstin: '22VWXYZ1234Q6Z5', name: 'Company F', risk: 0.25 },
                { gstin: '33ABCDE5678R7Z6', name: 'Company G', risk: 0.68 },
            ];

            const links = [
                { source: 0, target: 1, weight: 150000 },
                { source: 0, target: 4, weight: 250000 },
                { source: 1, target: 2, weight: 80000 },
                { source: 1, target: 3, weight: 120000 },
                { source: 2, target: 5, weight: 45000 },
                { source: 4, target: 6, weight: 300000 },
                { source: 3, target: 4, weight: 95000 },
                { source: 0, target: 2, weight: 200000 },
            ];

            return {
                nodes: companies.map((c, i) => ({ ...c, id: i })),
                links: links,
                centerNode: '18AABCT1234H1Z0',
            };
        }

        /**
         * Render graph
         */
        function renderGraph() {
            if (!graphData || graphData.nodes.length === 0) {
                showNotification('No graph data available', 'warning');
                return;
            }

            const container = document.getElementById('graph').parentElement;
            const width = container.offsetWidth;
            const height = 600;

            // Clear previous graph
            d3.select('#graph').selectAll('*').remove();

            svg = d3.select('#graph').attr('width', width).attr('height', height);

            // Create zoom behavior
            const zoom = d3.zoom().on('zoom', e => {
                g.attr('transform', e.transform);
            });

            svg.call(zoom);

            g = svg.append('g');

            // Create simulation
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(document.getElementById('linkDistance').value)))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(40));

            // Create links
            const link = g
                .selectAll('line')
                .data(graphData.links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', d => {
                    const source = graphData.nodes[d.source.id || d.source];
                    const target = graphData.nodes[d.target.id || d.target];
                    const sourceRisk = source?.risk || 0;
                    const targetRisk = target?.risk || 0;
                    return sourceRisk > 0.7 || targetRisk > 0.7 ? '#c0392b' : '#999';
                })
                .attr('stroke-width', d => {
                    return Math.sqrt(d.weight || 1) / 100;
                });

            // Create nodes
            const node = g
                .selectAll('circle')
                .data(graphData.nodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('r', d => {
                    return d.gstin === graphData.centerNode ? 15 : 10;
                })
                .attr('fill', d => {
                    if (d.risk >= 0.7) return '#e74c3c';
                    if (d.risk >= 0.3) return '#f39c12';
                    return '#27ae60';
                })
                .attr('stroke', d => {
                    return d.gstin === graphData.centerNode ? '#3498db' : '#fff';
                })
                .call(drag(simulation))
                .on('click', (e, d) => selectNode(d))
                .on('mouseover', (e, d) => showNodeInfo(e, d))
                .on('mouseout', hideNodeInfo);

            // Create labels
            const labels = g
                .selectAll('text')
                .data(graphData.nodes)
                .enter()
                .append('text')
                .attr('class', 'node-label')
                .attr('dy', '0.35em')
                .text(d => d.name.substring(0, 3))
                .style('display', document.getElementById('showLabels').checked ? 'block' : 'none');

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('cx', d => d.x).attr('cy', d => d.y);

                labels.attr('x', d => d.x).attr('y', d => d.y);
            });
        }

        /**
         * Drag behavior
         */
        function drag(simulation) {
            function dragstarted(e) {
                if (!e.active) simulation.alphaTarget(0.3).restart();
                e.subject.fx = e.subject.x;
                e.subject.fy = e.subject.y;
            }

            function dragged(e) {
                e.subject.fx = e.x;
                e.subject.fy = e.y;
            }

            function dragended(e) {
                if (!e.active) simulation.alphaTarget(0);
                e.subject.fx = null;
                e.subject.fy = null;
            }

            return d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);
        }

        /**
         * Select node
         */
        function selectNode(node) {
            selectedNode = node;
            document.getElementById('infoPanel').classList.add('show');

            document.getElementById('infoPanelGstin').textContent = node.gstin;
            document.getElementById('infoPanelName').textContent = node.name;
            document.getElementById('infoPanelRisk').textContent = getRiskLevelBadge(node.risk).level;

            const connections = graphData.links.filter(l => l.source.id === node.id || l.target.id === node.id);
            document.getElementById('infoPanelConnected').textContent = connections.length;

            document.getElementById('infoPanelFraudRing').textContent = node.inFraudRing ? '‚úì Yes' : 'No';
        }

        /**
         * Show node info tooltip
         */
        function showNodeInfo(e, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>${d.name}</strong><br/>
                GSTIN: ${d.gstin}<br/>
                Risk: ${getRiskLevelBadge(d.risk).level}
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = e.pageX + 10 + 'px';
            tooltip.style.top = e.pageY + 10 + 'px';
        }

        /**
         * Hide node info tooltip
         */
        function hideNodeInfo() {
            document.getElementById('tooltip').style.display = 'none';
        }

        /**
         * Toggle labels
         */
        function toggleLabels() {
            d3.selectAll('.node-label').style('display', document.getElementById('showLabels').checked ? 'block' : 'none');
        }

        /**
         * Toggle fraud rings
         */
        function toggleFraudRings() {
            renderGraph();
        }

        /**
         * Update zoom
         */
        function updateZoom() {
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            currentZoom = zoom;
            if (g) {
                g.attr('transform', `scale(${zoom})`);
            }
        }

        /**
         * Update simulation
         */
        function updateSimulation() {
            if (simulation) {
                simulation.force('link').distance(parseInt(document.getElementById('linkDistance').value));
                simulation.alpha(0.3).restart();
            }
        }

        /**
         * Reset graph view
         */
        function resetGraph() {
            document.getElementById('zoomSlider').value = 1;
            document.getElementById('linkDistance').value = 100;
            updateZoom();
            updateSimulation();
        }

        /**
         * Download graph as PNG
         */
        function downloadGraph() {
            const svg = document.getElementById('graph');
            const canvas = document.createElement('canvas');
            canvas.width = svg.clientWidth;
            canvas.height = svg.clientHeight;

            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'fraud-network-graph.png';
                link.click();
            };

            img.src = 'data:image/svg+xml;base64,' + btoa(new XMLSerializer().serializeToString(svg));
            showNotification('Graph downloaded', 'success');
        }

        /**
         * Update graph statistics
         */
        function updateGraphStats() {
            if (!graphData) return;

            document.getElementById('totalNodes').textContent = graphData.nodes.length;
            document.getElementById('totalConnections').textContent = graphData.links.length;

            const fraudRings = graphData.nodes.filter(n => n.risk >= 0.7).length;
            document.getElementById('fraudRingsCount').textContent = fraudRings;

            const density = (2 * graphData.links.length) / (graphData.nodes.length * (graphData.nodes.length - 1));
            document.getElementById('networkDensity').textContent = (density * 100).toFixed(1) + '%';
        }

        /**
         * View company details
         */
        function viewCompanyDetails() {
            if (selectedNode) {
                window.location.href = `/company-explorer.html?gstin=${selectedNode.gstin}`;
            }
        }
    </script>
</body>
</html>
